<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#1976d2">

  <!-- Security Headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">

  <!-- PWA Meta Tags -->
  <meta name="application-name" content="FiberOMS Insight - Sprout">
  <meta name="description" content="Mobile-first fiber optic network management for ISPs">
  <meta name="keywords" content="fiber optic, network management, ISP, field technician">
  <meta name="author" content="FiberOMS Development Team">

  <title>FiberOMS Insight</title>

  <!-- Progressive Web App Icons -->
  <link rel="icon" type="image/png"
    href="https://www.sproutfiberinternet.com/wp-content/uploads/2024/03/cropped-Sprout-favicon-color-32x32.png">
  <link rel="apple-touch-icon"
    href="https://www.sproutfiberinternet.com/wp-content/uploads/2024/03/cropped-Sprout-favicon-color-32x32.png">
  <link rel="manifest" href="./manifest.json">

  <!-- Performance Optimization -->
  <!-- Preconnect to critical third-party domains -->
  <link rel="preconnect" href="https://js.arcgis.com" crossorigin>
  <link rel="preconnect" href="https://basemaps.arcgis.com" crossorigin>
  <link rel="dns-prefetch" href="//js.arcgis.com">
  <link rel="dns-prefetch" href="//basemaps.arcgis.com">

  <!-- ArcGIS Map SDK theme stylesheets - deferred loading for faster FCP -->
  <link id="esri-theme-light" rel="preload" href="./assets/esri/themes/light/main.css" as="style"
    onload="this.onload=null;this.rel='stylesheet'" />
  <noscript>
    <link id="esri-theme-light" rel="stylesheet" href="./assets/esri/themes/light/main.css" />
  </noscript>
  <link id="esri-theme-dark" rel="stylesheet" href="./assets/esri/themes/dark/main.css" disabled />

  <!-- Main styles - deferred loading for non-critical styles -->
  <link rel="preload" href="/src/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript>
    <link rel="stylesheet" href="/src/style.css">
  </noscript>
</head>

<body>
  <!-- No JavaScript Fallback -->
  <noscript>
    <div class="noscript-fallback">
      <h1>JavaScript Required</h1>
      <p>This application requires JavaScript to function properly. Please enable JavaScript in your browser settings
        and reload the page.</p>
    </div>
  </noscript>

  <div id="app">
    <!-- Calcite Shell Layout -->
    <calcite-shell>
      <!-- Header Navigation -->
      <calcite-navigation slot="header" class="unified-header">
        <div slot="logo" class="brand-logo-container">
          <img src="./logos/sprout-logo-header.png" alt="Sprout Fiber" class="brand-logo" width="200" height="78">
        </div>
        <div slot="content-center" class="navigation-content-center">
          <div class="search-section">
            <calcite-autocomplete id="header-search"
              placeholder="Search subscribers, accounts, addresses (min 4 chars)..." scale="l" icon="search" clearable
              class="header-search-input">
              <!-- Search results will be populated here -->
            </calcite-autocomplete>
          </div>
          <div class="metrics-section">
            <calcite-chip scale="l" appearance="outline" id="metrics-chip">
              <span id="offline-count">0</span>
            </calcite-chip>
          </div>
        </div>
        <div slot="content-end" class="navigation-actions">
          <calcite-button id="refresh-dashboard" icon-start="refresh" appearance="transparent" scale="s"
            aria-label="Refresh dashboard"></calcite-button>
          <calcite-button id="theme-toggle" icon-start="brightness" appearance="transparent" scale="s"
            aria-label="Toggle theme"></calcite-button>
        </div>
      </calcite-navigation>

      <!-- Mobile Map Overlay for Offline Count -->
      <div id="mobile-offline-overlay" class="mobile-only">
        <calcite-chip scale="l" appearance="outline" id="mobile-metrics-chip">
          <span id="mobile-offline-count">0</span>
        </calcite-chip>
      </div>

      <!-- Side Panel - Desktop Only -->
      <calcite-shell-panel slot="panel-start" id="shell-panel-start" position="start" display-mode="dock"
        width-scale="m" class="desktop-only">
        <calcite-action-bar slot="action-bar">
          <calcite-action-group>
            <calcite-action id="layers-action" text="Subscribers" icon="users" active></calcite-action>
            <calcite-action id="osp-action" text="OSP" icon="utility-network"></calcite-action>
            <calcite-action id="vehicles-action" text="Vehicles" icon="car" hidden></calcite-action>
          </calcite-action-group>
          <calcite-action-group>
            <calcite-action id="power-outages-action" text="Power Outages" icon="camera-flash-off"></calcite-action>
            <calcite-action id="network-parent-action" text="Network" icon="linkChart"></calcite-action>
            <calcite-action id="tools-action" text="Tools" icon="wrench"></calcite-action>
          </calcite-action-group>
          <calcite-action id="info-action" text="Info" icon="information" slot="bottom-actions"></calcite-action>
        </calcite-action-bar>

        <calcite-panel heading="Subscribers" id="panel-content">
          <!-- Subscribers Content -->
          <div id="layers-content">

            <!-- Subscriber Statistics -->
            <calcite-block heading="Network Status" collapsible expanded>
              <calcite-icon slot="icon" icon="users"></calcite-icon>

              <div class="network-cards">
                <calcite-card class="status-card status-card-online">
                  <div slot="subtitle" class="status-online">
                    <calcite-icon icon="circle" scale="s"></calcite-icon>
                    <span>Online</span>
                  </div>
                  <div slot="title" id="online-count-display">--</div>
                </calcite-card>

                <calcite-card class="status-card status-card-offline">
                  <div slot="subtitle" class="status-offline">
                    <calcite-icon icon="circle" scale="s"></calcite-icon>
                    <span>Offline</span>
                  </div>
                  <div slot="title" id="offline-count-display">--</div>
                </calcite-card>
              </div>

              <!-- Last Updated Info -->
              <calcite-notice scale="s" width="full" kind="info">
                <div slot="message">
                  <calcite-icon icon="clock" class="clock-icon"></calcite-icon>
                  <span id="last-updated-display">Last updated: --</span>
                </div>
              </calcite-notice>
            </calcite-block>

            <!-- Layer Controls -->
            <calcite-block heading="Map Layers" collapsible expanded>
              <calcite-icon slot="icon" icon="layers"></calcite-icon>

              <calcite-list selection-mode="none">
                <calcite-list-item label="Online Subscribers" description="Show connected subscribers on map">
                  <calcite-icon slot="content-start" icon="circle" class="status-icon-success"></calcite-icon>
                  <calcite-switch slot="content-end" id="online-subscribers-switch"></calcite-switch>
                </calcite-list-item>

                <calcite-list-item label="Offline Subscribers" description="Show disconnected subscribers on map">
                  <calcite-icon slot="content-start" icon="circle" class="status-icon-danger"></calcite-icon>
                  <calcite-switch slot="content-end" id="offline-subscribers-switch" checked></calcite-switch>
                </calcite-list-item>

                <calcite-list-item label="Business Internet Only" description="Filter to show only business subscribers"
                  class="layer-toggle-item" hidden>
                  <calcite-icon slot="content-start" icon="organization" class="status-icon-business"
                    style="color: #9333ea;"></calcite-icon>
                  <calcite-switch slot="content-end" id="business-internet-filter-switch"></calcite-switch>
                </calcite-list-item>
              </calcite-list>
            </calcite-block>

            <!-- Actions -->
            <calcite-block heading="Actions" collapsible expanded>
              <calcite-icon slot="icon" icon="gear"></calcite-icon>

              <!-- Note: "Refresh Data" button (#refresh-data) was intentionally removed on 2025-01-22
                   and consolidated into the header refresh button (#refresh-dashboard) to eliminate
                   redundancy. The header button now performs all refresh operations. See DashboardManager.js -->
              <div class="actions-container">
                <div class="action-group action-group-spaced">
                  <calcite-button id="desktop-export-offline-csv-btn" icon-start="download" scale="s" width="full"
                    appearance="outline">
                    Export Offline Subscribers
                  </calcite-button>
                  <calcite-button id="desktop-export-all-csv-btn" icon-start="download" scale="s" width="full"
                    appearance="outline">
                    Export All Subscribers
                  </calcite-button>
                </div>
              </div>
            </calcite-block>

          </div>

          <!-- OSP Content -->
          <div id="osp-content" hidden>
            <calcite-block heading="OSP" collapsible expanded>
              <calcite-icon slot="icon" icon="utility-network"></calcite-icon>

              <calcite-list selection-mode="none">
                <calcite-list-item label="DA Boundaries" description="Service area boundaries">
                  <calcite-icon slot="content-start" icon="polygon" class="icon-polygon-blue"></calcite-icon>
                  <calcite-switch slot="content-end"></calcite-switch>
                </calcite-list-item>

                <calcite-list-item label="Main Line Fiber" description="Primary fiber routes">
                  <calcite-icon slot="content-start" icon="line" class="icon-line-brown"></calcite-icon>
                  <calcite-switch slot="content-end"></calcite-switch>
                </calcite-list-item>

                <!-- Main Line Old removed as it's not relevant for this ISP -->

                <calcite-list-item label="MST Terminals" description="Multi-service terminals">
                  <calcite-icon slot="content-start" icon="circle" class="icon-circle-cyan"></calcite-icon>
                  <calcite-switch slot="content-end"></calcite-switch>
                </calcite-list-item>


                <calcite-list-item label="Splitters" description="Optical splitters">
                  <calcite-icon slot="content-start" icon="diamond" class="icon-diamond-purple"></calcite-icon>
                  <calcite-switch slot="content-end"></calcite-switch>
                </calcite-list-item>

                <calcite-list-item label="Poles" description="Utility poles">
                  <calcite-icon slot="content-start" icon="rings" class="icon-pin-brown"></calcite-icon>
                  <calcite-switch slot="content-end"></calcite-switch>
                </calcite-list-item>

                <calcite-list-item label="Slack Loops" description="Fiber slack loops">
                  <calcite-icon slot="content-start" icon="circle" class="icon-circle-green"></calcite-icon>
                  <calcite-switch slot="content-end"></calcite-switch>
                </calcite-list-item>
              </calcite-list>
            </calcite-block>
          </div>

          <!-- Vehicles Content -->
          <div id="vehicles-content" hidden>
            <calcite-block heading="Vehicle Tracking" collapsible expanded>
              <calcite-icon slot="icon" icon="car"></calcite-icon>

              <calcite-list selection-mode="none">
                <calcite-list-item label="Electric Trucks" description="Track electric maintenance fleet">
                  <calcite-icon slot="content-start" icon="flash" class="icon-flash-green"></calcite-icon>
                  <calcite-switch slot="content-end"></calcite-switch>
                </calcite-list-item>

                <calcite-list-item label="Fiber Trucks" description="Track fiber installation fleet">
                  <calcite-icon slot="content-start" icon="car" class="icon-car-blue"></calcite-icon>
                  <calcite-switch slot="content-end"></calcite-switch>
                </calcite-list-item>
              </calcite-list>
            </calcite-block>

            <!-- Simple Vehicle List -->
            <div id="simple-vehicle-list" class="simple-vehicle-list-spaced">
              <calcite-list id="vehicle-list" selection-mode="none"
                filter-placeholder="Filter vehicles by name or driver">
                <!-- Vehicle items will be populated here -->
              </calcite-list>
            </div>
          </div>

          <!-- Power Outages Content -->
          <div id="power-outages-content" hidden>
            <!-- Power Outage Statistics -->
            <power-outage-stats id="power-outage-stats"></power-outage-stats>
          </div>

          <!-- Network Content -->
          <div id="network-parent-content" hidden>
            <calcite-block heading="Node Sites" collapsible expanded>
              <calcite-icon slot="icon" icon="layers"></calcite-icon>
              <calcite-list selection-mode="none">
                <calcite-list-item label="Node Sites" description="Network node locations">
                  <calcite-icon slot="content-start" icon="diamond" class="icon-diamond-gold"></calcite-icon>
                  <calcite-switch slot="content-end" checked></calcite-switch>
                </calcite-list-item>
              </calcite-list>
            </calcite-block>

            <calcite-block heading="Reports" collapsible expanded>
              <calcite-icon slot="icon" icon="report"></calcite-icon>
              <div class="actions-container">
                <calcite-button id="export-ta5k-reports-btn" icon-start="file-report" scale="s" width="full"
                  appearance="outline">
                  Export TA5K Node Reports
                </calcite-button>
              </div>
            </calcite-block>
          </div>


          <!-- Tools Content -->
          <div id="tools-content" hidden>
            <calcite-block heading="Weather Overlays" collapsible expanded>
              <calcite-list selection-mode="none">
                <calcite-list-item label="Weather Radar" description="Live weather overlay from RainViewer">
                  <calcite-icon slot="content-start" icon="rain" class="info-icon"></calcite-icon>
                  <calcite-switch slot="content-end"></calcite-switch>
                </calcite-list-item>
              </calcite-list>
            </calcite-block>

            <calcite-block heading="Measurement Tools" collapsible expanded>
              <calcite-button width="full" icon-start="measure-line" scale="s" id="distance-measurement-btn">Distance
                Measurement</calcite-button>
              <calcite-button width="full" icon-start="trash" scale="s" id="clear-measurement-btn">Clear
                Measurements</calcite-button>
            </calcite-block>
            <calcite-block heading="Offline Data Cache" collapsible expanded>
              <div id="cache-status" class="cache-status-container">
                <calcite-list selection-mode="none">
                  <calcite-list-item label="Cache Status" description="Loading cache information...">
                    <calcite-icon slot="content-start" icon="data"></calcite-icon>
                    <span slot="content-end" id="cache-size-text" class="text-secondary">--</span>
                  </calcite-list-item>
                </calcite-list>
                <div id="cache-details" class="cache-details-spaced"></div>
                <div class="cache-buttons-container">
                  <calcite-button width="full" appearance="outline" icon-start="refresh" scale="s"
                    id="refresh-cache-btn">Refresh Cache Info</calcite-button>
                  <calcite-button width="full" appearance="outline-fill" kind="danger" icon-start="trash" scale="s"
                    id="clear-cache-btn">Clear All Cache</calcite-button>
                </div>
              </div>
            </calcite-block>
          </div>

          <!-- Info Content -->
          <div id="info-content" hidden>
            <calcite-block heading="App Details" expanded>
              <div id="app-info" class="app-info-container">
                <calcite-list selection-mode="none">
                  <calcite-list-item label="Build Version" id="build-version-item">
                    <calcite-icon slot="content-start" icon="code"></calcite-icon>
                    <span slot="content-end" id="build-version-text" class="text-monospace">Loading...</span>
                  </calcite-list-item>
                  <calcite-list-item label="Last Updated" id="build-date-item">
                    <calcite-icon slot="content-start" icon="clock"></calcite-icon>
                    <span slot="content-end" id="build-date-text" class="text-secondary">Loading...</span>
                  </calcite-list-item>
                  <calcite-list-item label="Environment" id="environment-item">
                    <calcite-icon slot="content-start" icon="globe"></calcite-icon>
                    <span slot="content-end" id="environment-text" class="text-secondary">Loading...</span>
                  </calcite-list-item>
                </calcite-list>
              </div>
            </calcite-block>

            <calcite-block heading="Resources" collapsible expanded>
              <calcite-list selection-mode="none">
                <calcite-list-item label="Documentation" description="View application documentation">
                  <calcite-icon slot="content-start" icon="fileText"></calcite-icon>
                  <calcite-action slot="actions-end" icon="launch" id="docs-link"></calcite-action>
                </calcite-list-item>
                <calcite-list-item label="Report Issue" description="Submit bug reports or feedback">
                  <calcite-icon slot="content-start" icon="exclamation-mark-triangle"></calcite-icon>
                  <calcite-action slot="actions-end" icon="launch" id="issue-link"></calcite-action>
                </calcite-list-item>
              </calcite-list>
            </calcite-block>
          </div>
        </calcite-panel>
      </calcite-shell-panel>

      <!-- Main Content Area -->
      <div class="map-container">
        <arcgis-map id="map" basemap="streets-navigation-vector">
          <!-- Map Controls are dynamically created via JavaScript after map view initialization -->
          <!-- See Application.js loadOptionalUi() for component creation -->
          <!-- ArcGIS 4.34+ uses slot-based pattern: created programmatically and added to DOM after view is ready -->

          <!-- Distance Measurement Tool (2D) - pre-declared for faster access -->
          <arcgis-distance-measurement-2d id="distance-measurement-tool" slot="bottom-left" unit="imperial"
            hidden></arcgis-distance-measurement-2d>
        </arcgis-map>
      </div>

      <!-- Mobile Close Button - shows when panels are open -->
      <calcite-button id="mobile-close-button" class="mobile-only" width="full" appearance="outline" scale="l"
        icon-start="x">
        Close Panel
      </calcite-button>

      <!-- Mobile Bottom Navigation -->
      <calcite-segmented-control id="mobile-tab-bar" class="mobile-only" width="full" appearance="outline" scale="l">
        <calcite-segmented-control-item id="tab-search" value="search"
          icon-start="search"></calcite-segmented-control-item>
        <calcite-segmented-control-item id="tab-subscribers" value="subscribers"
          icon-start="users"></calcite-segmented-control-item>
        <calcite-segmented-control-item id="tab-osp" value="osp"
          icon-start="utility-network"></calcite-segmented-control-item>
        <calcite-segmented-control-item id="tab-vehicles" value="vehicles" icon-start="car"
          hidden></calcite-segmented-control-item>
        <calcite-segmented-control-item id="tab-other" value="other" icon-start="apps"></calcite-segmented-control-item>
      </calcite-segmented-control>
    </calcite-shell>


    <!-- Desktop Modals -->

    <!-- Truck Table Dialog -->
    <calcite-dialog id="truck-table-modal" width-scale="l" scale="l">
      <div slot="header" class="dialog-header">
        <span class="dialog-title">Truck Table - Vehicle Tracking and Status</span>
        <calcite-button appearance="transparent" kind="neutral" scale="s" icon-start="x" class="dialog-close-btn"
          aria-label="Close" onclick="document.getElementById('truck-table-modal').open = false"></calcite-button>
      </div>
      <div slot="content" class="truck-table-content">
        <!-- Search and Controls -->
        <div class="truck-table-controls">
          <calcite-input id="truck-search" type="search" placeholder="Search trucks or installers..." icon="search"
            scale="m" clearable>
          </calcite-input>

          <div class="truck-table-sort-controls">
            <label>Sort by:</label>
            <calcite-select id="truck-sort-select" scale="m">
              <calcite-option value="name">Truck Name</calcite-option>
              <calcite-option value="installer">Installer</calcite-option>
              <calcite-option value="type">Type</calcite-option>
              <calcite-option value="status">Status</calcite-option>
            </calcite-select>
            <calcite-button id="truck-refresh-btn" appearance="outline" scale="m" icon-start="refresh"
              title="Refresh truck data">
            </calcite-button>
          </div>
        </div>

        <!-- Table Container -->
        <div class="truck-table-container">
          <table class="truck-table">
            <thead>
              <tr>
                <th class="zoom-column">ZOOM</th>
                <th class="truck-name-column">TRUCK NAME</th>
                <th class="installer-column">INSTALLER</th>
                <th class="status-column">STATUS</th>
                <th class="location-column">LOCATION</th>
              </tr>
            </thead>
            <tbody id="truck-table-body">
              <!-- Truck rows will be populated here -->
            </tbody>
          </table>
        </div>

        <!-- Loading State -->
        <div id="truck-table-loading" class="truck-table-loading" hidden>
          <calcite-loader scale="m"></calcite-loader>
          <p>Loading truck data...</p>
        </div>

        <!-- Empty State -->
        <div id="truck-table-empty" class="truck-table-empty" hidden>
          <calcite-icon icon="car" scale="l"></calcite-icon>
          <h4>No trucks found</h4>
          <p>No vehicle data is currently available.</p>
        </div>

        <!-- Footer with stats -->
        <div class="truck-table-footer">
          <span id="truck-count">0 trucks</span>
          <span id="truck-last-updated">Last updated: --</span>
        </div>
      </div>
    </calcite-dialog>

    <!-- Mobile Bottom Modals -->

    <!-- Search Modal -->
    <calcite-dialog id="mobile-search-sheet" class="mobile-only" width-scale="l" scale="l">
      <div slot="header" class="dialog-header">
        <span class="dialog-title">Search</span>
        <calcite-button appearance="transparent" kind="neutral" scale="s" icon-start="x" class="dialog-close-btn"
          aria-label="Close"></calcite-button>
      </div>
      <div slot="content">
        <calcite-block heading="Quick Search" expanded>
          <calcite-input id="mobile-search-input" type="search" placeholder="Search addresses, customers, accounts..."
            icon="search" scale="l" clearable>
          </calcite-input>
        </calcite-block>



      </div>
    </calcite-dialog>

    <calcite-dialog id="mobile-subscribers-sheet" class="mobile-only" width-scale="l" scale="l">
      <div slot="header" class="dialog-header">
        <span class="dialog-title">Subscribers</span>
        <calcite-button appearance="transparent" kind="neutral" scale="s" icon-start="x" class="dialog-close-btn"
          aria-label="Close"></calcite-button>
      </div>
      <div slot="content">
        <!-- Network Status Summary -->
        <calcite-block heading="Network Status" expanded>
          <calcite-icon slot="icon" icon="users"></calcite-icon>

          <div class="mobile-network-status-cards">
            <div class="mobile-status-card mobile-status-card-online">
              <div class="mobile-status-label">
                <calcite-icon icon="circle" scale="s"></calcite-icon>
                <span>Online</span>
              </div>
              <div class="mobile-status-count" id="mobile-online-count-display">--</div>
            </div>

            <div class="mobile-status-card mobile-status-card-offline">
              <div class="mobile-status-label">
                <calcite-icon icon="circle" scale="s"></calcite-icon>
                <span>Offline</span>
              </div>
              <div class="mobile-status-count" id="mobile-offline-count-display">--</div>
            </div>
          </div>

          <!-- Last Updated Info -->
          <calcite-notice scale="s" width="full" kind="info">
            <div slot="message">
              <calcite-icon icon="clock" class="clock-icon"></calcite-icon>
              <span id="mobile-last-updated-display">Last updated: --</span>
            </div>
          </calcite-notice>
        </calcite-block>

        <calcite-block heading="Subscriber Status" expanded>
          <calcite-list-item label="Online Subscribers" description="Show active subscribers" class="layer-toggle-item">
            <calcite-icon slot="content-start" icon="circle" class="status-icon-success"></calcite-icon>
            <calcite-switch slot="content-end"></calcite-switch>
          </calcite-list-item>

          <calcite-list-item label="Offline Subscribers" description="Show disconnected subscribers"
            class="layer-toggle-item">
            <calcite-icon slot="content-start" icon="circle" class="status-icon-danger"></calcite-icon>
            <calcite-switch slot="content-end" checked></calcite-switch>
          </calcite-list-item>

          <calcite-list-item label="Business Internet Only" description="Filter to show only business subscribers"
            class="layer-toggle-item" hidden>
            <calcite-icon slot="content-start" icon="organization" class="status-icon-business"
              style="color: #9333ea;"></calcite-icon>
            <calcite-switch slot="content-end" id="mobile-business-internet-filter-switch"></calcite-switch>
          </calcite-list-item>
        </calcite-block>

        <calcite-block heading="Tools" expanded>
          <calcite-button width="full" icon-start="refresh" appearance="outline" id="refresh-subscriber-data">Refresh
            Data</calcite-button>
        </calcite-block>
      </div>
    </calcite-dialog>

    <calcite-dialog id="mobile-osp-sheet" class="mobile-only" width-scale="l" scale="l">
      <div slot="header" class="dialog-header">
        <span class="dialog-title">OSP Infrastructure</span>
        <calcite-button appearance="transparent" kind="neutral" scale="s" icon-start="x" class="dialog-close-btn"
          aria-label="Close"></calcite-button>
      </div>
      <div slot="content">
        <calcite-block heading="Network" expanded>
          <calcite-list-item label="Node Sites" description="Network node locations" class="layer-toggle-item">
            <calcite-icon slot="content-start" icon="diamond" class="icon-diamond-gold"></calcite-icon>
            <calcite-switch slot="content-end" checked></calcite-switch>
          </calcite-list-item>
        </calcite-block>

        <calcite-block heading="OSP" expanded>
          <calcite-list-item label="DA Boundaries" description="Service area boundaries" class="layer-toggle-item">
            <calcite-icon slot="content-start" icon="polygon" class="icon-polygon-blue"></calcite-icon>
            <calcite-switch slot="content-end"></calcite-switch>
          </calcite-list-item>

          <calcite-list-item label="Main Line Fiber" description="Primary fiber routes" class="layer-toggle-item">
            <calcite-icon slot="content-start" icon="line" class="icon-line-brown"></calcite-icon>
            <calcite-switch slot="content-end"></calcite-switch>
          </calcite-list-item>

          <!-- Main Line Old removed -->

          <calcite-list-item label="MST Terminals" description="Multi-service terminals" class="layer-toggle-item">
            <calcite-icon slot="content-start" icon="circle" class="icon-circle-cyan"></calcite-icon>
            <calcite-switch slot="content-end"></calcite-switch>
          </calcite-list-item>


          <calcite-list-item label="Splitters" description="Optical splitters" class="layer-toggle-item">
            <calcite-icon slot="content-start" icon="diamond" class="icon-diamond-purple"></calcite-icon>
            <calcite-switch slot="content-end"></calcite-switch>
          </calcite-list-item>

          <calcite-list-item label="Poles" description="Utility poles" class="layer-toggle-item">
            <calcite-icon slot="content-start" icon="rings" class="icon-pin-brown"></calcite-icon>
            <calcite-switch slot="content-end"></calcite-switch>
          </calcite-list-item>

          <calcite-list-item label="Slack Loops" description="Fiber slack loops" class="layer-toggle-item">
            <calcite-icon slot="content-start" icon="circle" class="icon-circle-green"></calcite-icon>
            <calcite-switch slot="content-end"></calcite-switch>
          </calcite-list-item>
        </calcite-block>
      </div>
    </calcite-dialog>

    <calcite-dialog id="mobile-vehicles-sheet" class="mobile-only" width-scale="l" scale="l">
      <div slot="header" class="dialog-header">
        <span class="dialog-title">Vehicle Tracking</span>
        <calcite-button appearance="transparent" kind="neutral" scale="s" icon-start="x" class="dialog-close-btn"
          aria-label="Close"></calcite-button>
      </div>
      <div slot="content">
        <calcite-block heading="Vehicle Tracking" expanded>
          <calcite-list-item label="Electric Trucks" description="Track electric maintenance fleet"
            class="layer-toggle-item">
            <calcite-icon slot="content-start" icon="flash" class="icon-flash-green"></calcite-icon>
            <calcite-switch slot="content-end"></calcite-switch>
          </calcite-list-item>

          <calcite-list-item label="Fiber Trucks" description="Track fiber installation fleet"
            class="layer-toggle-item">
            <calcite-icon slot="content-start" icon="car" class="icon-car-blue"></calcite-icon>
            <calcite-switch slot="content-end"></calcite-switch>
          </calcite-list-item>
        </calcite-block>

        <calcite-block heading="Tools" expanded>
          <calcite-button width="full" icon-start="refresh" appearance="outline">Refresh Vehicle
            Locations</calcite-button>
        </calcite-block>
      </div>
    </calcite-dialog>

    <calcite-dialog id="mobile-other-sheet" class="mobile-only" width-scale="l" scale="l">
      <div slot="header" class="dialog-header">
        <span class="dialog-title">Tools & Info</span>
        <calcite-button appearance="transparent" kind="neutral" scale="s" icon-start="x" class="dialog-close-btn"
          aria-label="Close"></calcite-button>
      </div>
      <div slot="content">
        <calcite-block heading="Environmental" expanded>
          <calcite-list selection-mode="none">
            <calcite-list-item label="Weather Radar" description="Live weather overlay from RainViewer"
              class="layer-toggle-item">
              <calcite-icon slot="content-start" icon="rain" class="info-icon"></calcite-icon>
              <calcite-switch slot="content-end"></calcite-switch>
            </calcite-list-item>
          </calcite-list>
        </calcite-block>

        <calcite-block heading="App Details" expanded>
          <div id="mobile-app-info" class="app-info-container">
            <calcite-list selection-mode="none">
              <calcite-list-item label="Build Version" id="mobile-build-version-item">
                <calcite-icon slot="content-start" icon="code"></calcite-icon>
                <span slot="content-end" id="mobile-build-version-text" class="text-monospace">Loading...</span>
              </calcite-list-item>
              <calcite-list-item label="Last Updated" id="mobile-build-date-item">
                <calcite-icon slot="content-start" icon="clock"></calcite-icon>
                <span slot="content-end" id="mobile-build-date-text" class="text-secondary">Loading...</span>
              </calcite-list-item>
              <calcite-list-item label="Environment" id="mobile-environment-item">
                <calcite-icon slot="content-start" icon="globe"></calcite-icon>
                <span slot="content-end" id="mobile-environment-text" class="text-secondary">Loading...</span>
              </calcite-list-item>
            </calcite-list>
          </div>
        </calcite-block>

        <calcite-block heading="Resources" expanded>
          <calcite-list selection-mode="none">
            <calcite-list-item label="Documentation" description="View application documentation">
              <calcite-icon slot="content-start" icon="fileText"></calcite-icon>
              <calcite-action slot="actions-end" icon="launch" id="mobile-docs-link"></calcite-action>
            </calcite-list-item>
            <calcite-list-item label="Report Issue" description="Submit bug reports or feedback">
              <calcite-icon slot="content-start" icon="exclamation-mark-triangle"></calcite-icon>
              <calcite-action slot="actions-end" icon="launch" id="mobile-issue-link"></calcite-action>
            </calcite-list-item>
          </calcite-list>
        </calcite-block>

      </div>
    </calcite-dialog>
  </div>

  <!-- Performance and Error Handling (deferred to end for faster FCP) -->
  <script>
    // Stencil/Calcite defensive polyfill: avoid errors when componentOnReady is missing on non-stencil elements
    if (!HTMLElement.prototype.componentOnReady) {
      HTMLElement.prototype.componentOnReady = function () { return Promise.resolve(this); };
    }

    // Polyfill for Node.js globals in browser
    if (typeof global === 'undefined') {
      window.global = window;
    }

    // Global error handler for production
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      // In production, you might want to send this to a logging service
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      // In production, you might want to send this to a logging service
    });

    // Production performance monitoring
    if ('performance' in window) {
      window.addEventListener('load', () => {
        setTimeout(() => {
          const perfData = performance.getEntriesByType('navigation')[0];
          if (perfData) {
            const loadMs = Math.round(perfData.duration || (perfData.loadEventEnd - (perfData.startTime || 0)) || 0);
            console.info('Page load time:', loadMs, 'ms');
          }
        }, 0);
      });
    }
  </script>

  <!-- Production Script Loading -->
  <script type="module" src="/src/main.js" onerror="console.error('Failed to load main application script')"></script>

  <!-- Fallback for browsers that don't support ES modules -->
  <script nomodule>
    alert('This application requires a modern browser that supports ES modules. Please update your browser.');
  </script>
</body>

</html>